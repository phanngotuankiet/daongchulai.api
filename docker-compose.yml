# Backend Docker Compose - chỉ chạy Backend services
# 5432 cho postgreSQL
# 8080 cho hasura
# 4002 cho backend

services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password123
      POSTGRES_DB: daongchulai
    volumes:
      - postgresql_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  hasura:
    image: hasura/graphql-engine:latest
    ports:
      - "8080:8080"
    environment:
      HASURA_GRAPHQL_DATABASE_URL: postgres://postgres:password123@postgres:5432/daongchulai
      HASURA_GRAPHQL_ENABLE_CONSOLE: "true"
      HASURA_GRAPHQL_DEV_MODE: "true"
      HASURA_GRAPHQL_ADMIN_SECRET: adminsecret123
      HASURA_GRAPHQL_UNAUTHORIZED_ROLE: anonymous
      HASURA_GRAPHQL_JWT_SECRET: '{"type":"HS256","key":"your-super-secret-jwt-key-change-this-in-production"}'
    depends_on:
      postgres:
        condition: service_healthy

  backend:
    build: 
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./:/app
      - /app/node_modules
    ports:
      - "4002:4002"
    environment:
      # Database Configuration
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-password123}
      DB_NAME: ${DB_NAME:-daongchulai}
      DB_PORT: ${DB_PORT:-5432}
      
      # Hasura Configuration
      HASURA_ADMIN_SECRET: ${HASURA_ADMIN_SECRET:-adminsecret123}
      HASURA_GRAPHQL_UNAUTHORIZED_ROLE: ${HASURA_GRAPHQL_UNAUTHORIZED_ROLE:-anonymous}
      HASURA_GRAPHQL_JWT_SECRET: ${HASURA_GRAPHQL_JWT_SECRET:-'{"type":"HS256","key":"your-super-secret-jwt-key-change-this-in-production"}'}
      HASURA_URL: ${HASURA_URL:-http://hasura:8080}
      
      # Application Configuration
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 4002
      
      # AWS S3 Configuration
      AWS_REGION: ${AWS_REGION:-ap-southeast-2}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_S3_BUCKET_NAME: ${AWS_S3_BUCKET_NAME:-daong}
    depends_on:
      - postgres
      - hasura
    command: >
      sh -c "
        # echo '🚀 Starting backend server...' &&
        # node server.js &
        # BACKEND_PID=$$! &&
        # echo '⏳ Waiting for Hasura to be ready...' &&
        # sleep 10 &&
        # echo '📋 Applying Hasura metadata...' &&
        # cd hasura &&
        # hasura metadata apply --endpoint http://hasura:8080 --admin-secret adminsecret123 &&
        # echo '🗄️ Applying migrations...' &&
        # hasura migrate apply --endpoint http://hasura:8080 --admin-secret adminsecret123 &&
        # echo '🌱 Applying seeds...' &&
        # hasura seed apply --endpoint http://hasura:8080 --admin-secret adminsecret123 &&
        # echo '✅ Backend setup completed!' &&
        # wait $$BACKEND_PID
        node server.js
      "

volumes:
  postgresql_data:
